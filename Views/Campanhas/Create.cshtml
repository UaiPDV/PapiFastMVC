@model BixWeb.Models.Campanha

@{
    ViewData["Title"] = "Criar Nova Campanha";
}

@section Styles {
    <link rel="stylesheet" href="~/css/Pages/Campanhas/criarCampanha.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
}

<!-- Cabeçalho da Página -->
<div class="form-page-header">
    <a asp-action="Index" class="form-back-link">
        <i class="bi bi-arrow-left-circle fs-2"></i>
    </a>
    <h1 class="form-page-title">Criar Nova Campanha</h1>
</div>

<!-- Formulário -->
<div class="form-main-card">
    <form asp-action="Create" novalidate>
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        
        <h2 class="form-section-title">1. Dados da Campanha</h2>
        <div class="row g-3">
            <!-- Nome da Campanha -->
            <div class="col-md-6">
                <label asp-for="nomeCampanha" class="form-label"></label>
                <input asp-for="nomeCampanha" class="form-control" placeholder="Ex: Happy Hour de Verão" />
                <span asp-validation-for="nomeCampanha" class="text-danger"></span>
            </div>

            <!-- Seleção de Filial -->
            <div class="col-md-6">
                <label asp-for="codFilial" class="form-label">Filial</label>
                <select asp-for="codFilial" class="form-select" asp-items="ViewBag.codFilial">
                    <option selected disabled value="">Selecione uma Filial</option>
                </select>
                <span asp-validation-for="codFilial" class="text-danger"></span>
            </div>

            <!-- Ativar ao Postar -->
            <div class="col-12 form-switch-container">
                <label for="campanhaAtiva" class="form-switch-wrapper">
                    <div class="form-switch-info">
                        <span class="form-switch-title">Ativar Campanha ao Postar</span>
                        <p class="form-switch-description">Marque esta opção se desejar que a campanha seja ativada imediatamente após o cadastro.</p>
                    </div>
                    <div class="form-toggle-switch">
                        <input class="form-check-input" type="checkbox" role="switch" asp-for="campanhaAtiva" id="campanhaAtiva">
                        <span class="form-toggle-slider"></span>
                    </div>
                </label>
            </div>
        </div>

        <!-- Container para a lista de produtos (Partial View) -->
        <div id="produtos-container" class="mt-5">
            <!-- O conteúdo de ViewProduto.cshtml será carregado aqui -->
        </div>

        <!-- Botões de Ação -->
        <div class="form-action-buttons">
            <a asp-action="Index" class="btn btn-light">Cancelar</a>
            <button type="submit" class="btn btn-primary d-flex align-items-center">
                <i class="bi bi-check-circle me-2"></i>
                Salvar Campanha
            </button>
        </div>
    </form>
</div>


@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Usamos jQuery para carregar a Partial View via AJAX
        $(document).ready(function () {
            $('#codFilial').change(function () {
                var filialId = $(this).val();
                if (filialId) {
                    // Faz a requisição para a sua Action que retorna a Partial View
                    // Certifique-se de que a URL está correta para o seu projeto
                    $('#produtos-container').load('/Campanhas/ViewProduto?id=' + filialId, function(response, status, xhr) {
                        if (status == "error") {
                            var msg = "<div class='alert alert-danger'>Desculpe, mas ocorreu um erro ao carregar os produtos: ";
                            $('#produtos-container').html(msg + xhr.status + " " + xhr.statusText + "</div>");
                        }
                    });
                } else {
                    $('#produtos-container').empty(); // Limpa a div se nenhuma filial for selecionada
                }
            });
        });
    </script>
}
